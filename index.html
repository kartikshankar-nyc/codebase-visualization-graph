<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Codebase Visualizer - Explore your code dependencies</title>
  <meta name="description" content="Visualize your codebase structure and dependencies with an elegant interactive graph" />
  <meta name="author" content="Lovable" />

  <meta property="og:title" content="Codebase Visualizer" />
  <meta property="og:description" content="Visualize your codebase structure and dependencies with an elegant interactive graph" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@lovable_dev" />
  <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  
  <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- CDN Dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reactflow@11.7.2/dist/reactflow.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sonner@0.5.0/dist/index.umd.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/reactflow@11.7.2/dist/style.css" rel="stylesheet">
  
  <!-- IMPORTANT: DO NOT REMOVE THIS SCRIPT TAG OR THIS VERY COMMENT! -->
  <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
  
  <style>
    /* Base styles */
    :root {
      --background: 210 33% 99%;
      --foreground: 220 20% 16%;
      --card: 0 0% 100%;
      --card-foreground: 220 20% 16%;
      --popover: 0 0% 100%;
      --popover-foreground: 220 20% 16%;
      --primary: 211 100% 50%;
      --primary-foreground: 0 0% 100%;
      --secondary: 210 20% 96%;
      --secondary-foreground: 220 20% 16%;
      --muted: 210 20% 96%;
      --muted-foreground: 220 20% 46%;
      --accent: 210 20% 96%;
      --accent-foreground: 220 20% 16%;
      --destructive: 0 84% 60%;
      --destructive-foreground: 0 0% 100%;
      --border: 214 32% 91%;
      --input: 214 32% 91%;
      --ring: 221 83% 53%;
      --radius: 0.75rem;
      --sidebar-background: 0 0% 100%;
      --sidebar-foreground: 220 20% 16%;
      --sidebar-primary: 211 100% 50%;
      --sidebar-primary-foreground: 0 0% 100%;
      --sidebar-accent: 210 20% 96%;
      --sidebar-accent-foreground: 220 20% 16%;
      --sidebar-border: 214 32% 91%;
      --sidebar-ring: 221 83% 53%;
    }

    .dark {
      --background: 220 20% 16%;
      --foreground: 210 20% 98%;
      --card: 220 20% 18%;
      --card-foreground: 210 20% 98%;
      --popover: 220 20% 18%;
      --popover-foreground: 210 20% 98%;
      --primary: 211 100% 50%;
      --primary-foreground: 0 0% 100%;
      --secondary: 216 28% 12%;
      --secondary-foreground: 210 20% 98%;
      --muted: 216 28% 12%;
      --muted-foreground: 215 20% 65%;
      --accent: 216 28% 12%;
      --accent-foreground: 210 20% 98%;
      --destructive: 0 62% 30%;
      --destructive-foreground: 210 20% 98%;
      --border: 216 28% 21%;
      --input: 216 28% 21%;
      --ring: 211 100% 50%;
      --sidebar-background: 220 20% 18%;
      --sidebar-foreground: 210 20% 98%;
      --sidebar-primary: 211 100% 50%;
      --sidebar-primary-foreground: 0 0% 100%;
      --sidebar-accent: 216 28% 12%;
      --sidebar-accent-foreground: 210 20% 98%;
      --sidebar-border: 216 28% 21%;
      --sidebar-ring: 211 100% 50%;
    }

    * {
      border-color: hsl(var(--border));
    }

    body {
      background-color: hsl(var(--background));
      color: hsl(var(--foreground));
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: hsla(var(--muted-foreground), 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: hsla(var(--muted-foreground), 0.5);
    }

    /* Animations for nodes and edges */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 hsla(var(--primary), 0.3); }
      70% { box-shadow: 0 0 0 10px hsla(var(--primary), 0); }
      100% { box-shadow: 0 0 0 0 hsla(var(--primary), 0); }
    }

    .scale-in {
      animation: scaleIn 0.4s ease-out forwards;
    }

    .slide-up {
      animation: slideUp 0.4s ease-out forwards;
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Flow related styles */
    .react-flow__edge-path {
      stroke-width: 1.5;
      stroke: hsla(var(--muted-foreground), 0.6);
    }

    .react-flow__edge-text {
      font-size: 10px;
      fill: hsl(var(--foreground));
    }

    .react-flow__edge.selected .react-flow__edge-path {
      stroke: hsl(var(--primary));
      stroke-width: 2;
    }

    .react-flow__handle {
      width: 8px;
      height: 8px;
      background-color: hsl(var(--background));
      border: 1.5px solid hsl(var(--primary));
    }

    .react-flow__handle:hover {
      background-color: hsl(var(--primary));
    }

    .react-flow__attribution {
      display: none;
    }

    .react-flow__controls {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 6px;
      background: hsl(var(--background));
      border: 1px solid hsl(var(--border));
    }

    .react-flow__controls-button {
      border-radius: 6px;
      padding: 4px;
      background: transparent;
      color: hsl(var(--foreground));
    }

    .react-flow__controls-button:hover {
      background: hsl(var(--secondary));
    }

    /* File tree styles */
    .file-tree {
      user-select: none;
    }

    .file-tree-item {
      transition: background-color 0.2s;
    }

    .file-tree-item:hover {
      background-color: hsl(var(--secondary));
    }

    .file-tree-item.selected {
      background-color: hsla(var(--primary), 0.1);
      color: hsl(var(--primary));
    }

    /* Glass panel styles */
    .glass-panel {
      background: hsla(var(--card), 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid hsla(var(--border), 0.5);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.03);
    }

    /* Lazy load transition */
    .lazy-image {
      filter: blur(20px);
      transition: filter 0.5s ease-out;
    }

    .lazy-image.loaded {
      filter: blur(0);
    }

    /* Node styles */
    .node {
      border-radius: 8px;
      background-color: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      padding: 12px 16px;
      font-size: 12px;
      min-width: 150px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }

    .node:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .node.file-node {
      background-color: hsl(var(--card));
    }

    .node.folder-node {
      background-color: hsla(var(--primary), 0.05);
    }

    .node.component-node {
      background-color: hsla(var(--accent), 0.7);
    }

    .node.function-node {
      border-left: 3px solid hsl(var(--primary));
    }

    .node.variable-node {
      border-left: 3px solid hsl(48, 100%, 67%);
    }

    .node.class-node {
      border-left: 3px solid hsl(275, 80%, 71%);
    }

    .node-header {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .node-type {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: hsl(var(--secondary));
      color: hsl(var(--secondary-foreground));
    }

    /* Tooltips */
    .custom-tooltip {
      background-color: hsl(var(--popover));
      color: hsl(var(--popover-foreground));
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid hsl(var(--border));
      max-width: 300px;
      z-index: 1000;
    }

    /* App structure */
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background-color: hsl(var(--card));
      border-bottom: 1px solid hsl(var(--border));
      padding: 0.75rem 1.5rem;
    }

    .sidebar {
      width: 20rem;
      border-right: 1px solid hsl(var(--border));
      background-color: hsl(var(--card));
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content {
      flex-grow: 1;
      display: flex;
    }

    .graph-container {
      flex-grow: 1;
      position: relative;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Toast Container -->
  <div id="toast-container"></div>

  <script>
    // Ensure Lucide is loaded before using it
    document.addEventListener('DOMContentLoaded', function() {
      // Wait to make sure Lucide is fully loaded
      if (typeof lucide === 'undefined') {
        console.error('Lucide library is not loaded');
        return;
      }
      
      // Explicitly create all icons we're going to use
      const iconsToCreate = [
        'layers', 'zap', 'upload', 'search', 'x', 'folderOpen', 
        'folder', 'file', 'chevronDown', 'chevronRight', 'refreshCw', 
        'settings', 'download'
      ];
      
      // Initialize Lucide icons
      lucide.createIcons({
        icons: iconsToCreate
      });
      
      // Create app structure
      const app = document.createElement('div');
      app.className = 'app';
      
      // Create header
      const header = document.createElement('header');
      header.className = 'header';
      header.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="text-primary mr-2"><i data-lucide="layers"></i></div>
            <h1 class="text-lg font-medium">Codebase Visualizer</h1>
          </div>
          
          <div class="flex items-center space-x-3">
            <button id="load-sample" class="text-sm py-1 px-3 border border-gray-200 rounded-full hover:bg-gray-100 transition-colors flex items-center">
              <i data-lucide="zap" class="w-4 h-4"></i>
              <span class="ml-1">Load Sample</span>
            </button>
            
            <div class="relative">
              <input type="file" id="folder-input" class="hidden" multiple />
              <button id="select-folder" class="text-sm py-1 px-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors flex items-center">
                <i data-lucide="upload" class="w-4 h-4"></i>
                <span class="ml-1">Select Folder</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Create content
      const content = document.createElement('div');
      content.className = 'content';
      
      // Create sidebar
      const sidebar = document.createElement('div');
      sidebar.className = 'sidebar';
      sidebar.innerHTML = `
        <div class="p-4 border-b border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <h2 class="font-medium">Project Structure</h2>
            <button id="toggle-search" class="p-1.5 rounded-full hover:bg-gray-100 transition-colors">
              <i data-lucide="search" class="w-4 h-4"></i>
            </button>
          </div>
          
          <div id="search-container" class="hidden animate-fadeIn">
            <div class="relative">
              <input
                type="text"
                id="search-input"
                placeholder="Search files..."
                class="w-full py-1.5 px-3 bg-white border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
              <button id="clear-search" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                <i data-lucide="x" class="w-3.5 h-3.5"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div id="file-tree" class="flex-grow overflow-y-auto p-2 file-tree">
          <div class="text-center py-8 text-gray-500">
            <i data-lucide="folder-open" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">No files to display</p>
            <p class="text-xs mt-1">Select a folder to visualize</p>
          </div>
        </div>
      `;
      
      // Create graph container
      const graphContainer = document.createElement('div');
      graphContainer.className = 'graph-container';
      graphContainer.id = 'reactflow-container';
      
      // Assemble the app
      content.appendChild(sidebar);
      content.appendChild(graphContainer);
      app.appendChild(header);
      app.appendChild(content);
      
      // Add to DOM
      document.getElementById('root').appendChild(app);
      
      // Initialize ReactFlow
      let reactFlowInstance;
      let nodes = [];
      let edges = [];
      
      // State variables
      let rootPath = '';
      let fileTree = null;
      let expandedFolders = new Set();
      let selectedItem = null;
      let isSearching = false;
      let searchTerm = '';
      let isSettingsOpen = false;
      let nodeSize = 150;
      let nodePadding = 20;
      let edgeStyle = 'default';
      let nodeColorScheme = 'default';
      let isLoading = false;
      
      // Initialize ReactFlow
      const reactFlowContainer = document.getElementById('reactflow-container');
      const { ReactFlow, Background, Controls, MiniMap, Panel, MarkerType } = ReactFlowUMD;
      const BackgroundVariant = {
        Dots: 'dots',
        Lines: 'lines',
        Cross: 'cross'
      };
      
      // Function to show toast notifications
      const toast = {
        info: (message) => showToast(message, 'info'),
        success: (message) => showToast(message, 'success'),
        error: (message) => showToast(message, 'error')
      };
      
      function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-md shadow-md text-white z-50 ${
          type === 'success' ? 'bg-green-500' : 
          type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
          setTimeout(() => toast.remove(), 500);
        }, 3000);
      }
      
      // Function to handle folder selection
      document.getElementById('select-folder').addEventListener('click', () => {
        document.getElementById('folder-input').click();
      });
      
      document.getElementById('folder-input').addEventListener('change', handleFolderSelect);
      
      // Function to generate a custom SVG for Lucide icons
      function generateIconSvg(iconName, size = 16) {
        if (!lucide.icons[iconName]) {
          console.warn(`Icon "${iconName}" not found in Lucide library`);
          // Return a simple SVG placeholder if icon not found
          return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
        }
        return `<i data-lucide="${iconName}" class="w-${size/4} h-${size/4}"></i>`;
      }
      
      // Function to handle folder selection
      function handleFolderSelect(event) {
        const items = event.target.files;
        
        if (!items || items.length === 0) {
          return;
        }
        
        setIsLoading(true);
        toast.info('Analyzing folder structure...');
        
        // Simulate processing delay
        setTimeout(() => {
          try {
            // Create a simulated file tree from the selected files
            const tree = simulateFileTree(items);
            
            rootPath = tree.name;
            fileTree = tree;
            
            // Generate initial graph
            generateDependencyGraph(tree);
            
            // Render file tree
            renderFileTree();
            
            toast.success('Folder structure loaded successfully!');
          } catch (error) {
            console.error('Error processing folder:', error);
            toast.error('Failed to process folder structure');
          } finally {
            setIsLoading(false);
          }
        }, 1000);
      }
      
      // Function to simulate file tree structure
      function simulateFileTree(items) {
        // Create a basic simulated structure for demo purposes
        const fileExtensions = ['.js', '.jsx', '.html', '.css', '.json', '.md'];
        const folderNames = ['src', 'components', 'utils', 'styles', 'assets', 'pages', 'hooks', 'contexts'];
        
        // Create root folder
        const root = {
          name: 'project-root',
          type: 'folder',
          children: []
        };
        
        // Create some folders
        for (let i = 0; i < 4; i++) {
          const folder = {
            name: folderNames[i % folderNames.length],
            type: 'folder',
            children: []
          };
          
          // Add files to each folder
          for (let j = 0; j < 3 + Math.floor(Math.random() * 5); j++) {
            const fileExt = fileExtensions[Math.floor(Math.random() * fileExtensions.length)];
            const fileName = `file${j + 1}${fileExt}`;
            
            folder.children.push({
              name: fileName,
              type: 'file',
              size: Math.floor(Math.random() * 100000),
              content: 'Simulated file content'
            });
          }
          
          // Add sub-folders with files
          if (Math.random() > 0.5) {
            const subFolder = {
              name: `${folderNames[(i + 4) % folderNames.length]}`,
              type: 'folder',
              children: []
            };
            
            for (let k = 0; k < 2 + Math.floor(Math.random() * 3); k++) {
              const fileExt = fileExtensions[Math.floor(Math.random() * fileExtensions.length)];
              const fileName = `subfile${k + 1}${fileExt}`;
              
              subFolder.children.push({
                name: fileName,
                type: 'file',
                size: Math.floor(Math.random() * 100000),
                content: 'Simulated sub-file content'
              });
            }
            
            folder.children.push(subFolder);
          }
          
          root.children.push(folder);
        }
        
        return root;
      }
      
      // Function to generate dependency graph
      function generateDependencyGraph(tree) {
        if (!tree) return;
        
        nodes = [];
        edges = [];
        const processedNodes = new Set();
        
        // Function to process a file or folder
        function processItem(item, parentId = null, level = 0, position = { x: 0, y: 0 }) {
          const id = `${level}-${item.name}-${Math.random().toString(36).substring(7)}`;
          
          if (processedNodes.has(id)) return;
          processedNodes.add(id);
          
          // Calculate position offset for visual appeal
          const xOffset = Math.random() * 100 - 50;
          const yOffset = Math.random() * 100 - 50;
          
          const nodePosition = {
            x: position.x + level * 250 + xOffset,
            y: position.y + level * 120 + yOffset
          };
          
          // Create node based on type
          const node = {
            id,
            data: { 
              label: item.name,
              type: item.type,
              size: item.size,
              level
            },
            position: nodePosition,
            className: `node ${item.type}-node slide-up`,
            style: { animationDelay: `${level * 0.1}s` }
          };
          
          nodes.push(node);
          
          // Connect to parent node if exists
          if (parentId) {
            const edgeId = `e-${parentId}-${id}`;
            edges.push({
              id: edgeId,
              source: parentId,
              target: id,
              animated: false,
              style: { strokeWidth: 1.5 },
              markerEnd: {
                type: MarkerType.ArrowClosed,
                width: 15,
                height: 15,
                color: '#888',
              },
              className: 'fade-in'
            });
          }
          
          // Process children for folders
          if (item.type === 'folder' && item.children) {
            item.children.forEach((child, index) => {
              // Adjust position for children
              const childPosition = {
                x: nodePosition.x + 50 + (index % 2) * 100,
                y: nodePosition.y + 100 + (index % 3) * 50
              };
              
              processItem(child, id, level + 1, childPosition);
            });
          }
          
          // Simulate some random dependencies between files
          if (item.type === 'file' && level > 0 && Math.random() > 0.7 && nodes.length > 5) {
            // Find a random node to connect to
            const randomNodeIndex = Math.floor(Math.random() * (nodes.length - 1));
            const randomNode = nodes[randomNodeIndex];
            
            if (randomNode && randomNode.id !== id && randomNode.id !== parentId) {
              const dependencyType = Math.random() > 0.5 ? 'imports' : 'exports';
              
              const depEdgeId = `dep-${id}-${randomNode.id}`;
              edges.push({
                id: depEdgeId,
                source: id,
                target: randomNode.id,
                label: dependencyType,
                animated: true,
                style: { 
                  stroke: dependencyType === 'imports' ? '#3b82f6' : '#10b981',
                  strokeWidth: 1.5,
                  strokeDasharray: '5,5' 
                },
                className: 'fade-in'
              });
            }
          }
        }
        
        // Start processing from the root
        processItem(tree, null, 0, { x: 250, y: 50 });
        
        // Render the graph
        renderGraph();
      }
      
      // Function to render the graph
      function renderGraph() {
        // Create ReactFlow component
        const reactFlow = React.createElement(
          ReactFlow,
          {
            nodes: nodes,
            edges: edges,
            onNodesChange: onNodesChange,
            onEdgesChange: onEdgesChange,
            onConnect: onConnect,
            onNodeClick: onNodeClick,
            onInit: onInit,
            nodeTypes: { customNode: customNode },
            fitView: true,
            minZoom: 0.1,
            maxZoom: 2,
            defaultViewport: { x: 0, y: 0, zoom: 0.5 }
          },
          [
            React.createElement(Background, {
              variant: BackgroundVariant.Dots,
              gap: 12,
              size: 1,
              color: 'hsl(214, 32%, 91%)'
            }),
            React.createElement(Controls, {
              className: 'bg-white border border-gray-200 rounded-md shadow-sm'
            }),
            React.createElement(MiniMap, {
              className: 'bg-white border border-gray-200 rounded-md shadow-sm',
              maskColor: 'rgba(240, 240, 240, 0.5)',
              nodeColor: (node) => {
                if (node.data?.type === 'file') return 'rgba(59, 130, 246, 0.3)';
                return 'rgba(209, 213, 219, 0.3)';
              }
            }),
            React.createElement(
              Panel,
              { position: 'top-right', className: 'space-x-2' },
              [
                createButton('Center Graph', 'refresh-cw', centerGraph),
                createButton('Visualization Settings', 'settings', toggleSettings),
                createButton('Export Dependencies', 'download', exportDependencies)
              ]
            ),
            isSettingsOpen && React.createElement(
              Panel,
              { position: 'top-center' },
              [React.createElement(SettingsPanel, {})]
            )
          ]
        );
        
        // Render to container
        ReactDOM.render(reactFlow, reactFlowContainer);
        
        // If loading overlay is needed
        if (isLoading) {
          renderLoadingOverlay();
        }
      }
      
      // Function to create a button
      function createButton(title, iconName, onClick) {
        return React.createElement(
          'button',
          {
            className: 'p-2 bg-white text-gray-800 border border-gray-200 rounded-md hover:bg-gray-100 transition-colors',
            onClick: onClick,
            title: title
          },
          [React.createElement('i', { 'data-lucide': iconName, className: 'w-4 h-4' })]
        );
      }
      
      // Custom node renderer
      function customNode(props) {
        const { data } = props;
        
        return React.createElement(
          'div',
          {},
          [
            React.createElement(
              'div',
              { className: 'node-header' },
              [
                data.type === 'file' 
                  ? React.createElement('i', { 'data-lucide': 'file', className: 'w-3.5 h-3.5' }) 
                  : React.createElement('i', { 'data-lucide': 'folder', className: 'w-3.5 h-3.5' }),
                React.createElement('span', {}, data.label)
              ]
            ),
            React.createElement('div', { className: 'node-type' }, data.type),
            data.size && React.createElement('div', { className: 'text-xs mt-1' }, formatBytes(data.size))
          ]
        );
      }
      
      // Settings panel
      function SettingsPanel() {
        const settings = {
          nodeSize,
          nodePadding,
          edgeStyle,
          colorScheme: nodeColorScheme
        };
        
        return React.createElement(
          'div',
          { className: 'glass-panel rounded-lg p-4 w-80 animate-fade-in' },
          [
            // Header
            React.createElement(
              'div',
              { className: 'flex justify-between items-center mb-4' },
              [
                React.createElement('h3', { className: 'font-medium' }, 'Visual Settings'),
                React.createElement(
                  'button',
                  { 
                    className: 'p-1 rounded-full hover:bg-gray-100',
                    onClick: () => setIsSettingsOpen(false)
                  },
                  [React.createElement('i', { 'data-lucide': 'x', className: 'w-4 h-4' })]
                )
              ]
            ),
            
            // Settings controls
            React.createElement(
              'div',
              { className: 'space-y-4' },
              [
                // Node size
                createRangeControl('Node Size', settings.nodeSize, 100, 300, (value) => {
                  settings.nodeSize = parseInt(value);
                }),
                
                // Node padding
                createRangeControl('Node Padding', settings.nodePadding, 10, 30, (value) => {
                  settings.nodePadding = parseInt(value);
                }),
                
                // Edge style
                createSelectControl('Edge Style', settings.edgeStyle, 
                  ['default', 'step', 'smoothstep', 'straight', 'bezier', 'animated'], 
                  (value) => {
                    settings.edgeStyle = value;
                  }
                ),
                
                // Color scheme
                createSelectControl('Color Scheme', settings.colorScheme, 
                  ['default', 'vibrant', 'pastel', 'monochrome'], 
                  (value) => {
                    settings.colorScheme = value;
                  }
                ),
                
                // Apply button
                React.createElement(
                  'button',
                  {
                    className: 'w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-colors',
                    onClick: () => applySettings(settings)
                  },
                  'Apply Changes'
                )
              ]
            )
          ]
        );
      }
      
      // Helper to create range control
      function createRangeControl(label, value, min, max, onChange) {
        return React.createElement(
          'div',
          {},
          [
            React.createElement('label', { className: 'block text-sm mb-1' }, label),
            React.createElement('input', {
              type: 'range',
              min: min,
              max: max,
              value: value,
              onChange: (e) => onChange(e.target.value),
              className: 'w-full'
            }),
            React.createElement(
              'div',
              { className: 'flex justify-between text-xs text-gray-500' },
              [
                React.createElement('span', {}, 'Small'),
                React.createElement('span', {}, 'Large')
              ]
            )
          ]
        );
      }
      
      // Helper to create select control
      function createSelectControl(label, value, options, onChange) {
        return React.createElement(
          'div',
          {},
          [
            React.createElement('label', { className: 'block text-sm mb-2' }, label),
            React.createElement(
              'div',
              { className: 'grid grid-cols-3 gap-2' },
              options.map(option => 
                React.createElement(
                  'button',
                  {
                    key: option,
                    className: `text-xs py-1 px-2 rounded border ${
                      value === option 
                        ? 'bg-blue-500 text-white border-blue-500' 
                        : 'border-gray-200 hover:bg-gray-50'
                    }`,
                    onClick: () => onChange(option)
                  },
                  option.charAt(0).toUpperCase() + option.slice(1)
                )
              )
            )
          ]
        );
      }
      
      // Function to render file tree
      function renderFileTree() {
        const fileTreeEl = document.getElementById('file-tree');
        fileTreeEl.innerHTML = '';
        
        if (fileTree) {
          // Filter tree if search term exists
          const filteredTree = searchTerm ? filterFileTree(fileTree, searchTerm) : fileTree;
          
          if (filteredTree) {
            const treeElement = renderFileTreeItem(filteredTree);
            fileTreeEl.appendChild(treeElement);
          } else {
            renderEmptyFileTree(fileTreeEl, 'No matching files found');
          }
        } else {
          renderEmptyFileTree(fileTreeEl);
        }
        
        // Ensure icons are created after DOM is updated
        lucide.createIcons();
      }
      
      // Function to render empty file tree message
      function renderEmptyFileTree(container, message = 'No files to display') {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i data-lucide="folder-open" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">${message}</p>
            <p class="text-xs mt-1">Select a folder to visualize</p>
          </div>
        `;
        
        // Create icons after updating the DOM
        lucide.createIcons();
      }
      
      // Function to render a file tree item
      function renderFileTreeItem(item, path = [], level = 0) {
        const itemPath = [...path, item.name].join('/');
        const isFolder = item.type === 'folder';
        const isExpanded = expandedFolders.has(itemPath);
        const isSelected = selectedItem === itemPath;
        
        const itemEl = document.createElement('div');
        itemEl.className = 'file-tree-item';
        itemEl.style.marginLeft = `${level * 16}px`;
        
        const itemHeader = document.createElement('div');
        itemHeader.className = `flex items-center py-1 px-2 rounded cursor-pointer ${isSelected ? 'selected' : ''}`;
        itemHeader.addEventListener('click', () => {
          if (isFolder) {
            toggleFolder(itemPath);
          } else {
            selectItem(item, itemPath);
          }
        });
        
        if (isFolder) {
          itemHeader.addEventListener('dblclick', () => {
            selectItem(item, itemPath);
          });
        }
        
        // Add folder toggle icon
        if (isFolder) {
          const toggleIcon = document.createElement('span');
          toggleIcon.className = 'mr-1';
          toggleIcon.innerHTML = isExpanded 
            ? `<i data-lucide="chevron-down" class="w-3.5 h-3.5"></i>` 
            : `<i data-lucide="chevron-right" class="w-3.5 h-3.5"></i>`;
          itemHeader.appendChild(toggleIcon);
        }
        
        // Add item icon
        const itemIcon = document.createElement('span');
        itemIcon.className = 'mr-2';
        itemIcon.innerHTML = isFolder 
          ? (isExpanded ? `<i data-lucide="folder-open" class="w-4 h-4"></i>` : `<i data-lucide="folder" class="w-4 h-4"></i>`)
          : `<i data-lucide="file" class="w-4 h-4"></i>`;
        itemHeader.appendChild(itemIcon);
        
        // Add item name
        const itemName = document.createElement('span');
        itemName.className = 'text-sm truncate';
        itemName.textContent = item.name;
        itemHeader.appendChild(itemName);
        
        itemEl.appendChild(itemHeader);
        
        // Add children if folder is expanded
        if (isFolder && isExpanded && item.children) {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'pl-2';
          
          item.children.forEach((child, i) => {
            const childEl = renderFileTreeItem(child, [...path, item.name], level + 1);
            childrenContainer.appendChild(childEl);
          });
          
          itemEl.appendChild(childrenContainer);
        }
        
        return itemEl;
      }
      
      // Function to toggle folder expansion
      function toggleFolder(folderPath) {
        if (expandedFolders.has(folderPath)) {
          expandedFolders.delete(folderPath);
        } else {
          expandedFolders.add(folderPath);
        }
        renderFileTree();
      }
      
      // Function to select an item in the file tree
      function selectItem(item, itemPath) {
        selectedItem = itemPath;
        renderFileTree();
        
        // Highlight the corresponding node
        if (item.type === 'file' || item.type === 'folder') {
          highlightNodeByLabel(item.name);
        }
      }
      
      // Function to highlight a node by label
      function highlightNodeByLabel(label) {
        nodes = nodes.map((n) => ({
          ...n,
          style: {
            ...n.style,
            borderColor: n.data.label === label ? '#3b82f6' : undefined,
            boxShadow: n.data.label === label ? '0 0 0 2px rgba(59, 130, 246, 0.2)' : undefined,
          },
        }));
        
        // Find the node to center view on it
        const nodeToFocus = nodes.find(n => n.data.label === label);
        if (nodeToFocus && reactFlowInstance) {
          reactFlowInstance.setCenter(
            nodeToFocus.position.x + 75, 
            nodeToFocus.position.y + 50, 
            { duration: 800 }
          );
        }
        
        renderGraph();
      }
      
      // Function to handle node click
      function onNodeClick(event, node) {
        // Highlight the node
        nodes = nodes.map((n) => ({
          ...n,
          style: {
            ...n.style,
            borderColor: n.id === node.id ? '#3b82f6' : undefined,
            boxShadow: n.id === node.id ? '0 0 0 2px rgba(59, 130, 246, 0.2)' : undefined,
          },
        }));
        
        renderGraph();
        
        // Find the corresponding item in the file tree
        findAndSelectFileTreeItem(fileTree, node.data.label);
      }
      
      // Function to find and select an item in the file tree
      function findAndSelectFileTreeItem(tree, itemName, path = []) {
        if (!tree) return false;
        
        if (tree.name === itemName) {
          selectedItem = [...path, tree.name].join('/');
          
          // Expand all parent folders
          const folderPaths = [];
          for (let i = 0; i < path.length; i++) {
            folderPaths.push(path.slice(0, i + 1).join('/'));
          }
          
          folderPaths.forEach(p => expandedFolders.add(p));
          renderFileTree();
          
          return true;
        }
        
        if (tree.children) {
          for (const child of tree.children) {
            if (findAndSelectFileTreeItem(child, itemName, [...path, tree.name])) {
              return true;
            }
          }
        }
        
        return false;
      }
      
      // Function to filter file tree based on search term
      function filterFileTree(tree, term) {
        if (!tree) return null;
        if (!term) return tree;
        
        // Check if current node matches
        const matches = tree.name.toLowerCase().includes(term.toLowerCase());
        
        // For files, just check if it matches
        if (tree.type === 'file') {
          return matches ? tree : null;
        }
        
        // For folders, also check children
        if (tree.children) {
          const filteredChildren = tree.children
            .map(child => filterFileTree(child, term))
            .filter(Boolean);
          
          if (matches || filteredChildren.length > 0) {
            return {
              ...tree,
              children: filteredChildren
            };
          }
        }
        
        return null;
      }
      
      // Function to handle nodes change
      function onNodesChange(changes) {
        // This would update nodes state, but we're handling it differently in vanilla JS
      }
      
      // Function to handle edges change
      function onEdgesChange(changes) {
        // This would update edges state, but we're handling it differently in vanilla JS
      }
      
      // Function to handle edge connections
      function onConnect(params) {
        const newEdge = {
          ...params,
          id: `edge-${params.source}-${params.target}`,
          animated: true,
          style: { stroke: '#3b82f6', strokeWidth: 1.5 },
          markerEnd: {
            type: MarkerType.ArrowClosed,
          },
          className: 'fade-in'
        };
        
        edges.push(newEdge);
        renderGraph();
      }
      
      // Initialize ReactFlow
      function onInit(instance) {
        reactFlowInstance = instance;
        
        // Fit view after a short delay to ensure rendering
        setTimeout(() => {
          if (reactFlowInstance) {
            reactFlowInstance.fitView({ padding: 0.2 });
          }
        }, 300);
      }
      
      // Function to center the graph
      function centerGraph() {
        if (reactFlowInstance) {
          reactFlowInstance.fitView({ padding: 0.2, duration: 800 });
          toast.success('Graph centered');
        }
      }
      
      // Function to toggle settings panel
      function toggleSettings() {
        isSettingsOpen = !isSettingsOpen;
        renderGraph();
      }
      
      // Function to apply visual settings
      function applySettings(settings) {
        nodeSize = settings.nodeSize;
        nodePadding = settings.nodePadding;
        edgeStyle = settings.edgeStyle;
        nodeColorScheme = settings.colorScheme;
        
        // Apply settings to nodes
        nodes = nodes.map((n) => ({
          ...n,
          style: {
            ...n.style,
            width: nodeSize,
            padding: nodePadding,
            // Apply color scheme
            backgroundColor: getNodeColorByScheme(n.data.type, nodeColorScheme),
          },
        }));
        
        // Apply settings to edges
        edges = edges.map((e) => ({
          ...e,
          // Apply edge style
          type: edgeStyle === 'bezier' ? 'default' : edgeStyle,
          animated: edgeStyle === 'animated',
        }));
        
        toast.success('Settings applied');
        isSettingsOpen = false;
        renderGraph();
      }
      
      // Get node color based on scheme and node type
      function getNodeColorByScheme(type, scheme) {
        if (scheme === 'default') return undefined;
        
        const schemes = {
          vibrant: {
            file: 'hsla(210, 100%, 97%, 1)',
            folder: 'hsla(211, 100%, 95%, 1)'
          },
          pastel: {
            file: 'hsla(180, 60%, 97%, 1)',
            folder: 'hsla(210, 60%, 95%, 1)'
          },
          monochrome: {
            file: 'hsla(220, 10%, 98%, 1)',
            folder: 'hsla(220, 10%, 95%, 1)'
          }
        };
        
        return schemes[scheme][type] || undefined;
      }
      
      // Function to export dependencies as CSV
      function exportDependencies() {
        if (!edges.length) {
          toast.error('No dependencies to export');
          return;
        }
        
        // Create CSV content
        let csv = 'Source,Target,Type\n';
        edges.forEach(edge => {
          const source = nodes.find(n => n.id === edge.source)?.data.label || edge.source;
          const target = nodes.find(n => n.id === edge.target)?.data.label || edge.target;
          const type = edge.label || 'depends on';
          
          csv += `"${source}","${target}","${type}"\n`;
        });
        
        // Create and download file
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        saveAs(blob, 'dependencies.csv');
        
        toast.success('Dependencies exported successfully');
      }
      
      // Format bytes to human readable format
      function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // Function to load sample data
      document.getElementById('load-sample').addEventListener('click', loadSampleData);
      
      function loadSampleData() {
        setIsLoading(true);
        toast.info('Loading sample codebase...');
        
        // Simulate API delay
        setTimeout(() => {
          try {
            // Create a more complex sample tree
            const sampleTree = createSampleCodebase();
            
            rootPath = sampleTree.name;
            fileTree = sampleTree;
            
            // Generate initial graph
            generateDependencyGraph(sampleTree);
            
            // Render file tree
            renderFileTree();
            
            toast.success('Sample codebase loaded successfully!');
          } catch (error) {
            console.error('Error loading sample data:', error);
            toast.error('Failed to load sample data');
          } finally {
            setIsLoading(false);
          }
        }, 1500);
      }
      
      // Create a realistic sample codebase structure
      function createSampleCodebase() {
        return {
          name: 'my-react-app',
          type: 'folder',
          children: [
            {
              name: 'node_modules',
              type: 'folder',
              children: [
                { name: 'react', type: 'folder', children: [
                  { name: 'package.json', type: 'file', size: 2540 },
                  { name: 'index.js', type: 'file', size: 12400 }
                ]},
                { name: 'typescript', type: 'folder', children: [
                  { name: 'package.json', type: 'file', size: 3210 },
                  { name: 'bin', type: 'folder', children: [
                    { name: 'tsc', type: 'file', size: 1450 }
                  ]}
                ]}
              ]
            },
            {
              name: 'src',
              type: 'folder',
              children: [
                { name: 'index.js', type: 'file', size: 320 },
                { name: 'App.js', type: 'file', size: 2100 },
                { name: 'App.css', type: 'file', size: 1230 },
                { 
                  name: 'components', 
                  type: 'folder', 
                  children: [
                    { name: 'Header.js', type: 'file', size: 1820 },
                    { name: 'Footer.js', type: 'file', size: 940 },
                    { name: 'Sidebar.js', type: 'file', size: 2670 },
                    { name: 'Button.js', type: 'file', size: 1050 }
                  ]
                },
                { 
                  name: 'pages', 
                  type: 'folder', 
                  children: [
                    { name: 'Home.js', type: 'file', size: 3240 },
                    { name: 'About.js', type: 'file', size: 1890 },
                    { name: 'Contact.js', type: 'file', size: 2340 }
                  ]
                },
                { 
                  name: 'utils', 
                  type: 'folder', 
                  children: [
                    { name: 'api.js', type: 'file', size: 2140 },
                    { name: 'helpers.js', type: 'file', size: 3060 },
                    { name: 'constants.js', type: 'file', size: 890 }
                  ]
                }
              ]
            },
            {
              name: 'public',
              type: 'folder',
              children: [
                { name: 'index.html', type: 'file', size: 830 },
                { name: 'favicon.ico', type: 'file', size: 4502 },
                { name: 'logo.png', type: 'file', size: 12400 }
              ]
            },
            { name: 'package.json', type: 'file', size: 2340 },
            { name: 'README.md', type: 'file', size: 4210 }
          ]
        };
      }
      
      // Function to toggle search mode
      document.getElementById('toggle-search').addEventListener('click', toggleSearch);
      
      function toggleSearch() {
        isSearching = !isSearching;
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        
        if (isSearching) {
          searchContainer.classList.remove('hidden');
          searchInput.focus();
          
          searchInput.addEventListener('input', function() {
            searchTerm = this.value.trim();
            if (searchTerm) {
              clearSearchBtn.classList.remove('hidden');
            } else {
              clearSearchBtn.classList.add('hidden');
            }
            renderFileTree();
          });
          
          clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchTerm = '';
            this.classList.add('hidden');
            renderFileTree();
          });
        } else {
          searchContainer.classList.add('hidden');
          searchTerm = '';
          renderFileTree();
        }
      }
      
      // Function to render loading overlay
      function renderLoadingOverlay() {
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center';
        overlay.innerHTML = `
          <div class="text-center p-6 rounded-lg">
            <div class="animate-spin h-8 w-8 border-t-2 border-blue-500 rounded-full mx-auto mb-4"></div>
            <p class="font-medium">Processing...</p>
            <p class="text-sm text-gray-500 mt-1">Analyzing codebase structure</p>
          </div>
        `;
        
        reactFlowContainer.appendChild(overlay);
      }
      
      // Function to set loading state
      function setIsLoading(value) {
        isLoading = value;
        
        if (value) {
          renderLoadingOverlay();
        } else {
          // Remove any existing loading overlays
          const overlays = reactFlowContainer.querySelectorAll('.absolute.inset-0');
          overlays.forEach(overlay => overlay.remove());
        }
      }
      
      // Load sample data on initial mount for demo purposes
      setTimeout(() => {
        // Give a little time for everything to initialize
        loadSampleData();
      }, 200);
    });
  </script>
</body>
</html>
